<!DOCTYPE html>
<html>
<head>
    <title>Sunday Morning Coffee Tour</title>
    <style>
        /* [Keep all your existing styles] */
        .date-error {
            color: red;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <h1>Sunday Morning Coffee Tour</h1>
    <div id="coffee-tours-container">
        <div class="loading">Loading coffee tours...</div>
    </div>

    <script>
        // Robust date parser that handles multiple formats
        function parseDate(dateString) {
            // Try ISO format first (YYYY-MM-DD)
            let date = new Date(dateString);
            if (!isNaN(date.getTime())) return date;
            
            // Try other common formats if needed
            date = new Date(dateString.replace(/(\d+)\/(\d+)\/(\d+)/, '$3-$1-$2'));
            return isNaN(date.getTime()) ? null : date;
        }

        // Format date for display with validation
        function formatDisplayDate(dateString) {
            const date = parseDate(dateString);
            if (!date) {
                return `<span>${dateString} <span class="date-error">(Invalid Date)</span></span>`;
            }
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Check if date is in the past (with validation)
        function isPastDate(dateString) {
            const date = parseDate(dateString);
            if (!date) return false;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date < today;
        }

        // [Keep your existing parseCSV() and loadCoffeeShops() functions]
        // But add this validation in loadCoffeeShops():
        async function loadCoffeeShops() {
            try {
                const response = await fetch('coffee_tours.csv');
                if (!response.ok) throw new Error('Failed to load CSV file');
                
                const csvText = await response.text();
                const coffeeShops = parseCSV(csvText);
                
                // Sort with invalid dates last
                coffeeShops.sort((a, b) => {
                    const dateA = parseDate(a.date) || new Date(8640000000000000);
                    const dateB = parseDate(b.date) || new Date(8640000000000000);
                    return dateA - dateB;
                });

                // [Rest of your existing display code]
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('coffee-tours-container').innerHTML = 
                    `<div class="error">
                        <p>Error loading coffee tours</p>
                        <p><small>${error.message}</small></p>
                        <p><small>Check your CSV format and ensure dates are YYYY-MM-DD</small></p>
                    </div>`;
            }
        }

        window.addEventListener('DOMContentLoaded', loadCoffeeShops);
    </script>
</body>
</html>