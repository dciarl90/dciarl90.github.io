<!DOCTYPE html>
<html>
<head>
    <title>Sunday Morning Coffee Tour</title>
    <style>
        /* [Keep all previous styles] */
        .debug-info {
            font-family: monospace;
            white-space: pre;
            background: #f0f0f0;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>Sunday Morning Coffee Tour</h1>
    <div id="coffee-tours-container">
        <div class="loading">Loading coffee tours...</div>
    </div>
    <div id="debug-container" style="display:none;"></div>

    <script>
        // Debug function to show raw data
        function showDebugInfo(data) {
            const debugDiv = document.getElementById('debug-container');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML = '<h3>Debug Information:</h3><div class="debug-info">' + 
                                JSON.stringify(data, null, 2) + '</div>';
        }

        // Enhanced date parser for M/D/YYYY format
        function parseMDYDate(dateString) {
            if (!dateString) return null;
            
            try {
                const parts = dateString.split('/').map(part => parseInt(part, 10));
                if (parts.length !== 3 || parts.some(isNaN)) return null;
                
                // Note: Months are 0-based in JavaScript Date
                const date = new Date(parts[2], parts[0] - 1, parts[1]);
                
                // Validate the date actually matches the input (handles invalid dates like 2/30/2023)
                if (date.getMonth() + 1 !== parts[0] || date.getDate() !== parts[1]) {
                    return null;
                }
                
                return date;
            } catch (e) {
                return null;
            }
        }

        // [Keep all other functions from previous version]
        // Modify parseCSV to be more lenient:
        function parseCSV(csvText) {
            // First normalize line endings and trim
            csvText = csvText.replace(/\r\n?/g, '\n').trim();
            
            const lines = csvText.split('\n');
            if (lines.length < 2) return []; // Need at least header + one row
            
            // Try both tab and comma delimiters
            let delimiter = '\t';
            if (lines[0].indexOf('\t') === -1 && lines[0].indexOf(',') !== -1) {
                delimiter = ',';
            }
            
            const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const obj = {};
                const currentline = line.split(delimiter);
                
                for (let j = 0; j < headers.length; j++) {
                    if (j < currentline.length) {
                        obj[headers[j]] = currentline[j] ? currentline[j].trim() : '';
                    }
                }
                
                // Only require name and date fields
                if (obj.name && obj.date) {
                    result.push(obj);
                }
            }
            
            return result;
        }

        async function loadCoffeeShops() {
            try {
                const response = await fetch('coffee_tours.csv');
                if (!response.ok) throw new Error('CSV file not found (404)');
                
                const csvText = await response.text();
                const coffeeShops = parseCSV(csvText);
                
                // Debug: Show what was parsed
                showDebugInfo({
                    csvSample: csvText.split('\n').slice(0, 3).join('\n'),
                    parsedData: coffeeShops,
                    firstDate: coffeeShops[0]?.date,
                    firstDateParsed: parseMDYDate(coffeeShops[0]?.date)
                });
                
                if (coffeeShops.length === 0) {
                    throw new Error('Found 0 valid entries. Check CSV format.');
                }
                
                // [Rest of your existing sorting and display code]
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('coffee-tours-container').innerHTML = 
                    `<div class="error">
                        <p>Error loading coffee tours</p>
                        <p><small>${error.message}</small></p>
                        <p><small>Required CSV format:</small></p>
                        <div class="debug-info">
name\taddress\tdate\ttime
Example Coffee\t123 Main St\t6/9/2025\t9:00 AM
                        </div>
                        <p><button onclick="location.reload()">Try Again</button></p>
                    </div>`;
            }
        }

        window.addEventListener('DOMContentLoaded', loadCoffeeShops);
    </script>
</body>
</html>