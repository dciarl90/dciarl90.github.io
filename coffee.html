<!DOCTYPE html>
<html>
<head>
    <title>Sunday Morning Coffee Tour</title>
    <style>
        /* [Keep all your existing styles] */
    </style>
</head>
<body>
    <h1>Sunday Morning Coffee Tour</h1>
    <div id="coffee-tours-container">
        <div class="loading">Loading coffee tours...</div>
    </div>

    <script>
        // Robust CSV parser that handles commas in fields (tab-delimited)
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) return []; // Need header + at least one row
            
            // Get headers (first line)
            const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
            
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Special parsing to handle commas in fields
                const fields = [];
                let currentField = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === '\t' && !inQuotes) {
                        fields.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                fields.push(currentField.trim()); // Add last field
                
                // Map fields to headers
                const obj = {};
                headers.forEach((header, index) => {
                    if (index < fields.length) {
                        obj[header] = fields[index].replace(/^"|"$/g, ''); // Remove surrounding quotes
                    }
                });
                
                if (obj.name && obj.date) {
                    result.push(obj);
                }
            }
            return result;
        }

        // [Keep all your other functions: parseMDYDate, formatDisplayDate, isPastDate]

        async function loadCoffeeShops() {
            try {
                const response = await fetch('coffee_tours.csv');
                if (!response.ok) throw new Error('CSV file not found');
                
                const csvText = await response.text();
                const coffeeShops = parseCSV(csvText);
                
                if (coffeeShops.length === 0) {
                    throw new Error('No valid entries found. Check your CSV format.');
                }
                
                // Debug: Log first entry to console
                console.log('First parsed entry:', coffeeShops[0]);
                
                // Sort by date
                coffeeShops.sort((a, b) => {
                    const dateA = parseMDYDate(a.date) || new Date(8640000000000000);
                    const dateB = parseMDYDate(b.date) || new Date(8640000000000000);
                    return dateA - dateB;
                });
                
                // Display coffee shops
                const container = document.getElementById('coffee-tours-container');
                container.innerHTML = '';
                
                coffeeShops.forEach(shop => {
                    const shopElement = document.createElement('div');
                    const isPast = isPastDate(shop.date);
                    shopElement.className = `coffee-shop ${isPast ? 'past' : ''}`;
                    
                    shopElement.innerHTML = `
                        <div class="name">${shop.name || 'Unnamed Coffee Shop'}</div>
                        <div class="date-time">
                            <span class="date">${formatDisplayDate(shop.date)}</span>
                            <span class="time">${shop.time || ''}</span>
                        </div>
                        ${shop.address ? `<div class="address">${shop.address}</div>` : ''}
                    `;
                    
                    container.appendChild(shopElement);
                });
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('coffee-tours-container').innerHTML = 
                    `<div class="error">
                        <p>Error loading coffee tours</p>
                        <p><small>${error.message}</small></p>
                        <p><small>Required format (tab-delimited):</small></p>
                        <pre>name\taddress\tdate\ttime
Example\t"123 Main St, Apt 4"\t6/9/2025\t9:00 AM</pre>
                        <p><button onclick="location.reload()">Try Again</button></p>
                    </div>`;
            }
        }

        window.addEventListener('DOMContentLoaded', loadCoffeeShops);
    </script>
</body>
</html>